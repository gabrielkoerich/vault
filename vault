#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"
CONFIG_DIR="${VAULT_CONFIG_DIR:-$HOME/.config/vault}"
PATHS_FILE="$CONFIG_DIR/paths"
SCAN_FILE="$CONFIG_DIR/scan.yml"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VAULT_FILE="${VAULT_FILE:-$HOME/.vault.tar.age}"
MANIFEST_FILE="${VAULT_FILE%.tar.age}-manifest"

usage() {
  cat <<EOF
vault $VERSION — lock down sensitive files with age encryption

usage:
  vault lockdown    encrypt and remove sensitive files from disk
  vault unlock      restore sensitive files from the encrypted vault
  vault scan        scan for exposed secrets and update paths config
  vault status      show whether vault is locked or unlocked
  vault paths       list configured sensitive paths
  vault version     show version

config:
  $PATHS_FILE           paths to lock (one per line)
  $SCAN_FILE            paths to scan for secrets (editable)

EOF
}

check_deps() {
  local missing=()
  for cmd in "$@"; do
    command -v "$cmd" &>/dev/null || missing+=("$cmd")
  done
  if [ ${#missing[@]} -gt 0 ]; then
    echo "error: missing dependencies: ${missing[*]}" >&2
    echo "install with: brew install ${missing[*]}" >&2
    exit 1
  fi
}

ensure_config() {
  if [ ! -f "$PATHS_FILE" ]; then
    echo "error: $PATHS_FILE not found" >&2
    echo "create it with one sensitive path per line (supports \$HOME)" >&2
    echo "run 'vault scan' to auto-detect sensitive paths" >&2
    exit 1
  fi
}

read_paths() {
  local paths=()
  while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    local expanded
    expanded="$(eval echo "$line")"
    if [ -e "$expanded" ]; then
      paths+=("$expanded")
    fi
  done < "$PATHS_FILE"

  # optionally collect .env files from $HOME
  read -p "scan for .env files under \$HOME? (Y/n) " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    while IFS= read -r envfile; do
      paths+=("$envfile")
    done < <(fd -t f -H -g '.env' "$HOME" 2>/dev/null)
  fi

  printf '%s\n' "${paths[@]}"
}

cmd_lockdown() {
  check_deps age fd
  ensure_config

  if [ -f "$VAULT_FILE" ]; then
    echo "error: $VAULT_FILE already exists — already locked? run 'vault unlock' first" >&2
    exit 1
  fi

  mapfile -t paths < <(read_paths)

  if [ ${#paths[@]} -eq 0 ]; then
    echo "nothing to lock — no sensitive files found"
    exit 0
  fi

  echo "locking ${#paths[@]} sensitive path(s):"
  printf '  %s\n' "${paths[@]}"

  # save manifest
  printf '%s\n' "${paths[@]}" > "$MANIFEST_FILE"

  # tar relative to $HOME and encrypt with passphrase
  echo ""
  echo "WARNING: if you lose your passphrase, you will lose access to all locked files."
  echo ""
  echo "enter a passphrase to encrypt the vault:"
  tar -cf - -C "$HOME" "${paths[@]/#$HOME\//}" | age -p -o "$VAULT_FILE"

  # verify before removing
  if [ ! -f "$VAULT_FILE" ]; then
    echo "error: vault not created, aborting — files are safe" >&2
    rm -f "$MANIFEST_FILE"
    exit 1
  fi

  # remove originals
  for p in "${paths[@]}"; do
    if command -v trash &>/dev/null; then
      trash "$p"
    else
      rm -rf "$p"
    fi
  done

  echo ""
  echo "locked. sensitive files encrypted to $VAULT_FILE"
  echo "run 'vault unlock' to restore"
  echo ""
  read -p "empty trash now? (y/n) " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    if [[ "$(uname)" == "Darwin" ]]; then
      osascript -e 'tell application "Finder" to empty the trash'
    fi
    echo "trash emptied"
  fi
}

cmd_unlock() {
  check_deps age
  if [ ! -f "$VAULT_FILE" ]; then
    echo "error: $VAULT_FILE not found — not locked?" >&2
    exit 1
  fi

  echo "enter your passphrase to decrypt the vault:"
  age --decrypt -o - "$VAULT_FILE" | tar -xf - -C "$HOME"

  rm -f "$VAULT_FILE" "$MANIFEST_FILE"
  echo "unlocked. all sensitive files restored"
}

cmd_scan() {
  check_deps fd rg
  mkdir -p "$CONFIG_DIR"
  touch "$PATHS_FILE"

  # copy default scan.yml if user doesn't have one
  if [ ! -f "$SCAN_FILE" ]; then
    local default_scan="$SCRIPT_DIR/scan.yml"
    # homebrew installs to share/vault/
    [ ! -f "$default_scan" ] && default_scan="$(brew --prefix 2>/dev/null)/share/vault/scan.yml"
    if [ -f "$default_scan" ]; then
      cp "$default_scan" "$SCAN_FILE"
      echo "created $SCAN_FILE from defaults"
      echo "edit it to customize what vault scans for"
      echo ""
    else
      echo "error: no scan.yml found" >&2
      exit 1
    fi
  fi

  local found=0
  add_path() {
    local p="$1"
    local label="$2"
    local entry="\$HOME/${p#$HOME/}"
    if ! rg -qF "$entry" "$PATHS_FILE"; then
      echo "$entry" >> "$PATHS_FILE"
      echo "  added: $entry ($label)"
      found=$((found + 1))
    fi
  }

  echo "scanning for exposed secrets..."

  # check paths from scan.yml
  while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    local raw="${line#- }"
    raw="${raw%%#*}"        # strip inline comments
    raw="${raw%"${raw##*[![:space:]]}"}"  # trim trailing whitespace
    local expanded
    expanded="$(eval echo "$raw")"
    [ -e "$expanded" ] && add_path "$expanded" "scan.yml"
  done < "$SCAN_FILE"

  # scan shell files for exported secrets
  for f in "$HOME/.zshrc" "$HOME/.zprofile" "$HOME/.bashrc" "$HOME/.bash_profile"; do
    if [ -f "$f" ] && rg -qi '(API_KEY|SECRET|TOKEN|PASSWORD|PRIVATE_KEY)=' "$f" 2>/dev/null; then
      add_path "$f" "secrets in shell config"
    fi
  done

  # scan for .env files in $HOME
  while IFS= read -r envfile; do
    add_path "$envfile" ".env file"
  done < <(fd -t f -H -g '.env' "$HOME" 2>/dev/null || true)

  # scan for private key files
  while IFS= read -r keyfile; do
    local dir
    dir="$(dirname "$keyfile")"
    add_path "$dir" "private key found"
  done < <(rg -l --glob '*.pem' --glob '*.key' --glob '*.p12' 'PRIVATE KEY' "$HOME/.config" "$HOME/.local" 2>/dev/null || true)

  if [ "$found" -eq 0 ]; then
    echo "no new paths found — vault config is up to date"
  else
    echo ""
    echo "added $found new path(s) to $PATHS_FILE"
  fi
}

cmd_status() {
  if [ -f "$VAULT_FILE" ]; then
    echo "locked"
    if [ -f "$MANIFEST_FILE" ]; then
      echo ""
      echo "encrypted paths:"
      sed 's/^/  /' "$MANIFEST_FILE"
    fi
  else
    echo "unlocked"
  fi
}

cmd_paths() {
  ensure_config
  echo "configured paths ($PATHS_FILE):"
  echo ""
  while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    local expanded
    expanded="$(eval echo "$line")"
    if [ -e "$expanded" ]; then
      echo "  $line"
    else
      echo "  $line (missing)"
    fi
  done < "$PATHS_FILE"
}

case "${1:-}" in
  lockdown|lock) cmd_lockdown ;;
  unlock) cmd_unlock ;;
  scan) cmd_scan ;;
  status) cmd_status ;;
  paths) cmd_paths ;;
  version|-v|--version) echo "vault $VERSION" ;;
  help|-h|--help|"") usage ;;
  *) echo "unknown command: $1" >&2; usage; exit 1 ;;
esac
